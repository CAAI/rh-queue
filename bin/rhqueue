#!/usr/bin/python3
import argparse
import subprocess
import os
import datetime
import sys
import getpass
from rhqueue import *


class RHQueueParser(object):

  def __init__(self):
    self.processor = ScriptCreatorClass()
    parser = argparse.ArgumentParser(description="RHQueue")
    parser.add_argument(
        "command", help="The subcommand to run options are queue,remove,info")
    args = parser.parse_args(sys.argv[1:2])
    if not hasattr(self, args.command):
      print("not found")
      parser.print_help()
      exit(1)
    getattr(self, args.command)()

  def remove(self):
    parser = argparse.ArgumentParser(description="RHQueue remover")
    parser.add_argument(
        "job", nargs=1, help="the job id of the job to cancel", type=int)
    args = parser.parse_args(sys.argv[2:])
    queue = subprocess.Popen(["squeue"],
                             stdout=subprocess.PIPE).stdout.readlines()
    data = DataGrid(queue)

    data.cancel_job(args.job)

  def queue(self):
    parser = argparse.ArgumentParser(description="RHQueue")
    parser.add_argument(
        "script",
        metavar="script",
        type=str,
        help="The script to run on a gpu\n" +
        "at the top of each file there must be the shebang '#!/usr/bin/env python -u\n"
    )

    parser.add_argument(
        "-v",
        "--venv",
        metavar="venv",
        type=str,
        help="The virtual environment used for the project")

    parser.add_argument(
        "-p",
        "--priority",
        type=str,
        choices=["1", "2", "3", "4", "5"],
        default="3",
        help="The priority of the script" +
        "\nDO NOT DEFINE UNLESS YOU ARE SURE THAT YOU DO NOT NEED HIGHER PRIORITY."
    )

    parser.add_argument(
        "-e",
        "--email",
        type=str,
        help="The email to send to when the script begins and ends.\n" +
        "Can be defined as environment variable (export RHQ_EMAIL=<email>) to always send to that email."
        +
        "This will prefer the email given in the argument line over the environtment variable"
    )

    parser.add_argument(
        "-o",
        "--output-file",
        type=str,
        default="my.stdout",
        help="The file for the output of the script")

    parser.add_argument(
        "-b", "--begin-time", type=str, help="Begin script after (b) seconds")

    parser.add_argument(
        "-t",
        "--titan",
        type=str,
        help="Define the titans that the script can run on. Comma Seperated values"
    )
    args = parser.parse_args(sys.argv[2:])

    # base script at 0 as this is the "center" point
    self.processor.add_scriptline("srun -n1 ./{}".format(args.script), 0)
    self.processor.add_scriptline("export PYTHONUNBUFFERED=1", -5)

    # base sbatch arguments
    self.processor.add_sbatchline("--priority", args.priority)
    self.processor.add_sbatchline("--ntasks", "1")
    self.processor.add_sbatchline("--gres", "gpu:titan:1")
    self.processor.add_sbatchline("-o", getattr(args, "output_file",
                                                "my.stdout"))

    if args.begin_time:
      self.processor.add_sbatchline("--begin", "now+{}".format(args.begin_time))
      print(
          f"begin time approx: {datetime.datetime.now()+ datetime.timedelta(minutes=int(args.begin_time))}"
      )

    # Handle Email
    email = os.environ.get("RHQ_EMAIL", "")
    email = args.email if args.email else email

    if email:
      self.processor.add_scriptline("./send_email_start {}".format(email), -10)
      self.processor.add_scriptline("./send_email_end {}".format(email), 2)
      print(f"email: {email}")

    #Handle venv
    venv = os.environ.get("RHQ_VENV", "")
    venv = os.environ.get("VIRTUAL_ENV", venv)
    venv = args.venv if args.venv else venv
    if venv:
      self.processor.add_scriptline("source {}/bin/activate".format(venv), -1)
      self.processor.add_scriptline("deactivate", 1)
      print(f"venv: {venv}")

    if args.titan:
      titans = args.titan.split(",") if "," in args.titan else args.titan
      w_string = "titan[{}]" if all(i.isdecimal() for i in titans) else "{}"
      self.processor.add_sbatchline("-w", w_string.format(",".join(titans)))
      print(f"titans:{w_string.format(','.join(titans))}")

    self.processor.add_scriptline("chmod +x {}".format(args.script), -2)
    self.processor.write_file()
    script = "sbatch ./{}".format(self.processor.script_name)
    subprocess.call(["chmod +x {}".format(args.script)],
                    stdout=subprocess.PIPE,
                    shell=True)
    subprocess.call(["{}".format(script)], stdout=subprocess.PIPE, shell=True)
    subprocess.call(["rm ./script.sh"], stdout=subprocess.PIPE, shell=True)

  def info(self):
    info = subprocess.Popen(["squeue"],
                            stdout=subprocess.PIPE,
                            stdin=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                            shell=True)
    with open("./squeue", "a+") as f:
      f.write(b"".join(info.stdout.readlines()).decode("utf-8"))
    print(getpass.getuser())


class DataGrid(object):

  def __init__(self, output):
    self.admin = ["pmcd"]
    self.headers = self._handle_line(output[0])
    self.data = []
    self.user = getpass.getuser()
    for line in output[1:]:
      self.data.append(self._handle_line(line))

  def _handle_line(self, line):
    print(line, type(line))
    return [data for data in line[:-1].split(" ") if data]

  def get_info_about_user(self):
    ret = []
    for line in self.data:
      if line[3] == self.user:
        ret.append(line)
    return ret

  def get_line_by_job_id(self, job_id):
    for line in self.data:
      if line[0] == job_id:
        return line
    return None

  def is_user_job(self, job_id):
    for line in self.data:
      if (line[3] == self.user or
          self.user in self.admin) and line[0] == job_id:
        return True
    return False

  def cancel_job(self, job_id):
    if self.is_user_job(job_id) and self.get_line_by_job_id(job_id) is not None:
      job_res_id = self.get_line_by_job_id(job_id)[0]
      # print("cancelled {}".format(job_res_id))
      subprocess.call(["scancel {}".format(job_id[0])])
    else:
      print("You do not have the permission to cancel that job")


if __name__ == "__main__":
  RHQueueParser()
  # data = DataGrid(open("./squeue", "r").readlines())
  # data.get_info_about_user()
  # data.cancel_job("285")
